<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Nested Sliding Panels - Vanilla JS</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family:
					system-ui,
					-apple-system,
					sans-serif;
				height: 100vh;
				display: flex;
				flex-direction: column;
			}

			.controls {
				padding: 1rem;
				background: #f5f5f5;
				border-bottom: 1px solid #ddd;
				display: flex;
				gap: 1rem;
				align-items: center;
				flex-wrap: wrap;
			}

			button {
				padding: 0.5rem 1rem;
				border: 1px solid #333;
				background: white;
				cursor: pointer;
				border-radius: 4px;
				font-size: 14px;
			}

			button:hover {
				background: #f0f0f0;
			}

			button:disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}

			button.back-button {
				background: #667eea;
				color: white;
				border-color: #667eea;
			}

			button.back-button:hover:not(:disabled) {
				background: #5568d3;
			}

			label {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				font-size: 14px;
			}

			.app-container {
				flex: 1;
				position: relative;
				overflow: hidden;
				background: #e0e0e0;
			}

			/* Sliding container - can be nested */
			.sliding-container {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				overflow: hidden;
			}

			.panel {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				display: flex;
				flex-direction: column;
				transition: transform 0.4s ease-in-out;
			}

			/* Panel content area */
			.panel-header {
				padding: 2rem;
				background: rgba(0, 0, 0, 0.1);
				border-bottom: 2px solid rgba(0, 0, 0, 0.1);
			}

			.panel-header h1 {
				font-size: 2rem;
				color: white;
				margin-bottom: 0.5rem;
			}

			.panel-header p {
				color: rgba(255, 255, 255, 0.9);
			}

			.panel-body {
				flex: 1;
				padding: 2rem;
				overflow-y: auto;
			}

			.panel-a {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			}

			.panel-b {
				background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
			}

			.panel-c {
				background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
			}

			.panel-d {
				background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
			}

			.panel-e {
				background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
			}

			/* Transition states */
			.panel.active {
				transform: translateX(0);
			}

			.panel.inactive-left {
				transform: translateX(-100%);
			}

			.panel.inactive-right {
				transform: translateX(100%);
			}

			.panel.slide-out-left {
				transform: translateX(-100%);
			}

			.panel.slide-out-right {
				transform: translateX(100%);
			}

			/* Navigation list styling */
			.nav-list {
				list-style: none;
				display: flex;
				flex-direction: column;
				gap: 1rem;
			}

			.nav-item {
				background: white;
				padding: 1.5rem;
				border-radius: 8px;
				cursor: pointer;
				transition:
					transform 0.2s,
					box-shadow 0.2s;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}

			.nav-item:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
			}

			.nav-item h3 {
				margin-bottom: 0.5rem;
				color: #333;
			}

			.nav-item p {
				color: #666;
				font-size: 0.9rem;
			}

			.status {
				margin-left: auto;
				font-size: 14px;
				color: #666;
			}

			.breadcrumb {
				font-size: 14px;
				color: #666;
				padding: 0.5rem;
				background: white;
				border-radius: 4px;
			}
		</style>
	</head>
	<body>
		<div class="controls">
			<button id="backBtn" class="back-button" disabled>‚Üê Back</button>
			<div class="breadcrumb" id="breadcrumb">Home</div>
			<label>
				<input type="checkbox" id="destroyInactive" checked />
				Destroy inactive panels
			</label>
			<span class="status" id="status">Navigation depth: 0</span>
		</div>

		<div class="app-container" id="app"></div>

		<script>
			class SlidingContainer {
				constructor(element, options = {}) {
					this.element = element;
					this.activePanel = null;
					this.isTransitioning = false;
					this.destroyInactive = options.destroyInactive ?? true;
					this.transitionDuration = options.transitionDuration ?? 400;
					this.onNavigate = options.onNavigate || (() => {});

					// Navigation stack for back functionality
					this.navigationStack = [];
				}

				async navigateTo(panelElement, direction = "forward") {
					if (this.isTransitioning) {
						console.log("Transition in progress, ignoring navigation");
						return;
					}

					if (this.activePanel === panelElement) {
						console.log("Panel already active");
						return;
					}

					this.isTransitioning = true;

					const outgoingPanel = this.activePanel;
					const incomingPanel = panelElement;

					// Add to navigation stack if moving forward
					if (direction === "forward" && outgoingPanel) {
						this.navigationStack.push(outgoingPanel);
					}

					if (outgoingPanel) {
						await this.performTransition(outgoingPanel, incomingPanel, direction);
					} else {
						// No outgoing panel, just show incoming
						if (!incomingPanel.parentElement) {
							this.element.appendChild(incomingPanel);
						}
						incomingPanel.classList.add("active");
					}

					this.activePanel = incomingPanel;
					this.isTransitioning = false;
					this.onNavigate();
				}

				async performTransition(outgoingPanel, incomingPanel, direction) {
					// Set up incoming panel position
					if (direction === "forward") {
						incomingPanel.classList.add("inactive-right");
					} else {
						incomingPanel.classList.add("inactive-left");
					}

					// Add incoming panel to DOM if not already there
					if (!incomingPanel.parentElement) {
						this.element.appendChild(incomingPanel);
					}

					// Force reflow
					incomingPanel.offsetHeight;

					// Start transitions
					if (direction === "forward") {
						outgoingPanel.classList.add("slide-out-left");
						incomingPanel.classList.remove("inactive-right");
						incomingPanel.classList.add("active");
					} else {
						outgoingPanel.classList.add("slide-out-right");
						incomingPanel.classList.remove("inactive-left");
						incomingPanel.classList.add("active");
					}

					// Wait for transition
					await this.waitForTransition(outgoingPanel);

					// Clean up outgoing panel
					if (this.destroyInactive && direction === "forward") {
						// When going forward, destroy the outgoing panel
						outgoingPanel.classList.remove("slide-out-left", "active");
						outgoingPanel.classList.add("inactive-left");
						outgoingPanel.remove();
					} else {
						// When going back or keeping panels, just move off-screen
						outgoingPanel.classList.remove("slide-out-left", "slide-out-right", "active");
						outgoingPanel.classList.add(
							direction === "forward" ? "inactive-left" : "inactive-right"
						);
					}

					// Clean up incoming panel
					incomingPanel.classList.remove(
						"slide-in-from-left",
						"slide-in-from-right",
						"inactive-left",
						"inactive-right"
					);
				}

				waitForTransition(element) {
					return new Promise((resolve) => {
						const handleTransitionEnd = (e) => {
							if (e.target === element && e.propertyName === "transform") {
								element.removeEventListener("transitionend", handleTransitionEnd);
								resolve();
							}
						};

						element.addEventListener("transitionend", handleTransitionEnd);

						setTimeout(() => {
							element.removeEventListener("transitionend", handleTransitionEnd);
							resolve();
						}, this.transitionDuration + 100);
					});
				}

				async goBack() {
					if (this.navigationStack.length === 0 || this.isTransitioning) {
						return false;
					}

					const previousPanel = this.navigationStack.pop();

					// Re-create the panel if it was destroyed
					if (!previousPanel.parentElement && this.destroyInactive) {
						// Panel was destroyed, we need to restore it
						// In a real app, you'd need to restore the panel state here
						console.warn("Panel was destroyed, state may be lost");
					}

					await this.navigateTo(previousPanel, "back");
					return true;
				}

				canGoBack() {
					return this.navigationStack.length > 0 && !this.isTransitioning;
				}

				getDepth() {
					return this.navigationStack.length;
				}

				setDestroyInactive(value) {
					this.destroyInactive = value;
				}
			}

			// Panel factory functions
			function createPanelA(container) {
				const panel = document.createElement("div");
				panel.className = "panel panel-a";
				panel.innerHTML = `
                <div class="panel-header">
                    <h1>Home</h1>
                    <p>Welcome to the nested navigation demo</p>
                </div>
                <div class="panel-body">
                    <ul class="nav-list">
                        <li class="nav-item" data-navigate="b">
                            <h3>Messages</h3>
                            <p>View your messages and conversations</p>
                        </li>
                        <li class="nav-item" data-navigate="settings">
                            <h3>Settings</h3>
                            <p>Manage your preferences (Coming soon)</p>
                        </li>
                    </ul>
                </div>
            `;

				// Add click handlers
				panel.querySelectorAll("[data-navigate]").forEach((item) => {
					item.addEventListener("click", () => {
						const target = item.getAttribute("data-navigate");
						if (target === "b") {
							const panelB = createPanelB(container);
							container.navigateTo(panelB, "forward");
						}
					});
				});

				return panel;
			}

			function createPanelB(container) {
				const panel = document.createElement("div");
				panel.className = "panel panel-b";

				// Create nested sliding container for Panel B's children
				const nestedContainer = document.createElement("div");
				nestedContainer.className = "sliding-container";

				panel.appendChild(nestedContainer);

				// Initialize nested sliding container
				const nestedSlider = new SlidingContainer(nestedContainer, {
					destroyInactive: container.destroyInactive,
					onNavigate: updateUI,
				});

				// Store reference for cleanup
				panel._nestedSlider = nestedSlider;

				// Create Panel B's initial view (list of conversations)
				const listView = document.createElement("div");
				listView.className = "panel panel-b";
				listView.innerHTML = `
                <div class="panel-header">
                    <h1>Messages</h1>
                    <p>Your conversations</p>
                </div>
                <div class="panel-body">
                    <ul class="nav-list">
                        <li class="nav-item" data-navigate="c1">
                            <h3>Conversation with Alice</h3>
                            <p>Hey, how are you doing?</p>
                        </li>
                        <li class="nav-item" data-navigate="c2">
                            <h3>Conversation with Bob</h3>
                            <p>Can we meet tomorrow?</p>
                        </li>
                        <li class="nav-item" data-navigate="c3">
                            <h3>Group: Project Team</h3>
                            <p>Meeting notes attached</p>
                        </li>
                    </ul>
                </div>
            `;

				// Add click handlers for conversations
				listView.querySelectorAll("[data-navigate]").forEach((item) => {
					item.addEventListener("click", () => {
						const target = item.getAttribute("data-navigate");
						const title = item.querySelector("h3").textContent;
						const conversationPanel = createConversationPanel(nestedSlider, title);
						nestedSlider.navigateTo(conversationPanel, "forward");
					});
				});

				// Show the list view initially
				nestedSlider.navigateTo(listView, "forward");

				return panel;
			}

			function createConversationPanel(container, title) {
				const panel = document.createElement("div");
				panel.className = "panel panel-c";
				panel.innerHTML = `
                <div class="panel-header">
                    <h1>${title}</h1>
                    <p>Message thread</p>
                </div>
                <div class="panel-body">
                    <ul class="nav-list">
                        <li class="nav-item" data-navigate="detail">
                            <h3>View Details</h3>
                            <p>See conversation info and settings</p>
                        </li>
                        <li class="nav-item" data-navigate="media">
                            <h3>Shared Media</h3>
                            <p>Photos and files from this conversation</p>
                        </li>
                    </ul>
                    <div style="margin-top: 2rem; padding: 1rem; background: rgba(255,255,255,0.9); border-radius: 8px;">
                        <p style="color: #333; margin-bottom: 0.5rem;"><strong>Demo message 1</strong></p>
                        <p style="color: #666; font-size: 0.9rem;">This is a sample message in the conversation.</p>
                    </div>
                </div>
            `;

				// Add click handlers
				panel.querySelectorAll("[data-navigate]").forEach((item) => {
					item.addEventListener("click", () => {
						const target = item.getAttribute("data-navigate");
						const detailTitle = item.querySelector("h3").textContent;
						const detailPanel = createDetailPanel(detailTitle);
						container.navigateTo(detailPanel, "forward");
					});
				});

				return panel;
			}

			function createDetailPanel(title) {
				const panel = document.createElement("div");
				panel.className = "panel panel-d";
				panel.innerHTML = `
                <div class="panel-header">
                    <h1>${title}</h1>
                    <p>Detail view</p>
                </div>
                <div class="panel-body">
                    <div style="background: rgba(255,255,255,0.9); padding: 2rem; border-radius: 8px;">
                        <h3 style="color: #333; margin-bottom: 1rem;">Detail Information</h3>
                        <p style="color: #666;">This is a deeply nested panel (level 3 from root). You can continue nesting as deep as you need.</p>
                        <p style="color: #666; margin-top: 1rem;">Use the back button to navigate back through the hierarchy.</p>
                    </div>
                </div>
            `;
				return panel;
			}

			// Initialize the app
			const appElement = document.getElementById("app");
			const rootContainer = new SlidingContainer(appElement, {
				destroyInactive: true,
				onNavigate: updateUI,
			});

			// Create and show initial panel
			const initialPanel = createPanelA(rootContainer);
			rootContainer.navigateTo(initialPanel, "forward");

			// Set up back button
			const backBtn = document.getElementById("backBtn");
			backBtn.addEventListener("click", async () => {
				// Try to go back in nested containers first
				let currentPanel = rootContainer.activePanel;

				if (currentPanel && currentPanel._nestedSlider) {
					const didGoBack = await currentPanel._nestedSlider.goBack();
					if (didGoBack) {
						updateUI();
						return;
					}
				}

				// If no nested navigation, go back in root
				await rootContainer.goBack();
				updateUI();
			});

			// Destroy inactive toggle
			const destroyCheckbox = document.getElementById("destroyInactive");
			destroyCheckbox.addEventListener("change", (e) => {
				rootContainer.setDestroyInactive(e.target.checked);
			});

			function updateUI() {
				// Calculate total depth including nested containers
				let depth = rootContainer.getDepth();
				let currentPanel = rootContainer.activePanel;

				if (currentPanel && currentPanel._nestedSlider) {
					depth += currentPanel._nestedSlider.getDepth() + 1;
				}

				// Update breadcrumb
				const breadcrumb = document.getElementById("breadcrumb");
				const paths = ["Home"];
				if (depth > 0) paths.push("Messages");
				if (depth > 1) paths.push("Conversation");
				if (depth > 2) paths.push("Details");
				breadcrumb.textContent = paths.join(" > ");

				// Update status
				const status = document.getElementById("status");
				status.textContent = `Navigation depth: ${depth}`;

				// Enable/disable back button
				let canGoBack = rootContainer.canGoBack();
				if (!canGoBack && currentPanel && currentPanel._nestedSlider) {
					canGoBack = currentPanel._nestedSlider.canGoBack();
				}
				backBtn.disabled = !canGoBack;
			}

			// Initial UI update
			updateUI();
		</script>
	</body>
</html>
